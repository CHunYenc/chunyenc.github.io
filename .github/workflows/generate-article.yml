name: Generate AI Article

on:
  # æ¯æœˆ 1 è™Ÿå’Œ 15 è™Ÿçš„ UTC 09:00 (å°ç£æ™‚é–“ 17:00) è‡ªå‹•åŸ·è¡Œ
  schedule:
    - cron: "0 9 1,15 * *"
  # æ”¯æ´æ‰‹å‹•è§¸ç™¼
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  generate:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Generate article with Gemini API
        id: generate
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: python scripts/generate_article.py

      - name: Create PR with generated article
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ARTICLE_PATH: ${{ steps.generate.outputs.article_path }}
          ARTICLE_TITLE: ${{ steps.generate.outputs.article_title }}
        run: |
          DATE_TAG=$(date +'%Y%m%d-%H%M%S')
          BRANCH_NAME="ai-article/${DATE_TAG}"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # å»ºç«‹æ–°åˆ†æ”¯
          git checkout -b "${BRANCH_NAME}"

          # æäº¤æ–‡ç« 
          git add content/posts/ai/
          git diff --cached --quiet && echo "No changes to commit" && exit 0
          git commit -m "feat: add AI generated article - ${ARTICLE_TITLE}"
          git push -u origin "${BRANCH_NAME}"

          # ç¢ºä¿ label å­˜åœ¨ï¼ˆå¦‚æœä¸å­˜åœ¨å°±å»ºç«‹ï¼‰
          gh label create "ai-generated" --description "ç”± AI è‡ªå‹•ç”Ÿæˆçš„æ–‡ç« " --color "7057ff" 2>/dev/null || true

          # å»ºç«‹ PR
          gh pr create \
            --title "ğŸ“ AI æ–‡ç« : ${ARTICLE_TITLE}" \
            --body "## AI è‡ªå‹•ç”Ÿæˆæ–‡ç« 

          æ­¤ PR ç”± GitHub Actions è‡ªå‹•å»ºç«‹ï¼ŒåŒ…å«ä¸€ç¯‡ç”± Gemini API ç”Ÿæˆçš„ç§‘æŠ€è¶¨å‹¢æ–‡ç« ã€‚

          **æ–‡ç« æ¨™é¡Œï¼š** ${ARTICLE_TITLE}
          **æ–‡ç« è·¯å¾‘ï¼š** \`${ARTICLE_PATH}\`
          **ç”Ÿæˆæ™‚é–“ï¼š** $(date +'%Y-%m-%d %H:%M:%S') UTC

          ### å¯©æ ¸æ¸…å–®

          - [ ] æ–‡ç« å…§å®¹å“è³ªæ˜¯å¦åˆæ ¼
          - [ ] æ¨™é¡Œèˆ‡æè¿°æ˜¯å¦æ°ç•¶
          - [ ] ç¨‹å¼ç¢¼ç¯„ä¾‹æ˜¯å¦æ­£ç¢ºï¼ˆå¦‚æœ‰ï¼‰

          > è«‹å¯©æ ¸æ–‡ç« å¾Œæ±ºå®šæ˜¯å¦åˆä½µã€‚å¦‚å“è³ªä¸ä½³å¯ç›´æ¥é—œé–‰æ­¤ PRã€‚" \
            --label "ai-generated" \
            --base master
